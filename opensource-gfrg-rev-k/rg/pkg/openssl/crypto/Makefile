ifndef JMKE_ENV_INCLUDED
  JMK_ROOT=../../../
  include $(JMK_ROOT)/jmk/env_root.mak
endif

COMMON_SUBDIRS+=$(if $(CONFIG_RG_OPENSSL_MD5),md5)
COMMON_SUBDIRS+=$(if $(CONFIG_RG_OPENSSL_SHA),sha)
COMMON_SUBDIRS+=$(if $(CONFIG_RG_OPENSSL_DES),des)
COMMON_SUBDIRS+=$(if $(CONFIG_RG_OPENSSL_MD4),md4)

CRYPTO_LIB_SUBDIRS=stack err bio lhash buffer rand bn ripemd rsa dsa dso dh \
  objects evp asn1 pem x509 x509v3 conf txt_db pkcs7 pkcs12 comp \
  rc4 hmac rc2 aes ui ocsp pqueue $(if $(CONFIG_RG_OPENSSL_BLOWFISH),bf) \
  $(if $(CONFIG_RG_OPENSSL_CAST),cast) ts modes cmac

# all directories are entered just to export their headers
JMK_ARCHCONFIG_SUBDIRS=$(COMMON_SUBDIRS) $(CRYPTO_LIB_SUBDIRS)

JMK_A_TARGET:=$(notdir $(JMK_A_TARGET))

ifndef CONFIG_RG_CRYPTO
  JMK_SUBDIRS=$(COMMON_SUBDIRS)
  JMK_O_OBJS_$(JMK_A_TARGET)=crypto_stubs.o mem_clr.o
else
  JMK_SUBDIRS=$(COMMON_SUBDIRS) $(CRYPTO_LIB_SUBDIRS)
  JMK_O_OBJS_$(JMK_A_TARGET)=cryptlib.o mem.o mem_clr.o mem_dbg.o cversion.o \
	  ex_data.o cpt_err.o ebcdic.o uid.o o_time.o o_str.o o_dir.o o_fips.o \
	  o_init.o fips_ers.o
endif

ifdef CONFIG_DYN_LINK
  JMK_SO_TARGET=$(JMK_A_TARGET:%.a=%.so)
  JMK_RAMDISK_LIB_FILES=$(JMK_SO_TARGET)
  JMK_L_OBJS_$(JMK_SO_TARGET)=$(JMK_A_TARGET)
  JMK_SO_CFLAGS=-Wl,--whole-archive
endif

JMK_CREATE_LOCAL=$(JMK_A_TARGET)

JMK_EXPORT_HEADERS= crypto.h opensslv.h opensslconf.h ebcdic.h \
	symhacks.h md32_common.h ossl_typ.h
JMK_INTERNAL_HEADERS=cryptlib.h o_time.h o_str.h o_dir.h crypto_stubs.c LPdir_unix.c

JMK_EXPORT_LIBS=liblocal_crypto.a
ifdef CONFIG_DYN_LINK
  JMK_EXPORT_LIBS+=$(JMK_SO_TARGET)
else
  JMK_EXPORT_LIBS+=$(JMK_A_TARGET)
endif

JMK_ARCHCONFIG_JPKG_FIRST_TASKS+=$(JMKE_PWD_BUILD)/buildinf.h

$(JMKE_PWD_BUILD)/buildinf.h: $(JMKE_PWD_SRC)/Makefile
	( echo "#ifndef MK1MF_BUILD"; \
	echo "  /* auto-generated by crypto/Makefile.ssl for crypto/cversion.c */"; \
	echo "  #define JMK_CFLAGS \"$(CC) $(CFLAG)\""; \
	echo "  #define PLATFORM \"$(PLATFORM)\""; \
	echo "  #define DATE \"`LC_ALL=C LC_TIME=C date`\""; \
	echo "#endif" ) > $@

$(call JMKE_INCLUDE_RULES)
